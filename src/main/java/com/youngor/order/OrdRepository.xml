<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<!-- mawujun qq:16064988 e-mail:16064988@qq.com-->
<mapper namespace="com.youngor.order.OrdRepository">
	<!-- 查询语句，会自动分页-->
    <select id="queryPage" resultType="com.youngor.order.Ord" parameterType="map">
    	select * from ord_ord
    </select> 
     <!-- 名称模式为：****_count,也可以不写，但如果查询叫复杂的话，自己写有助于控制查询性能-->
    <select id="queryPage_count" resultType="int" parameterType="map">
    	select count(a.id)
		from ord_ord a
    </select>
    
     <select id="haveOrd" resultType="com.youngor.order.Ord" parameterType="com.youngor.order.Ord">
     	select * from ORD_ORD
       where ormtno=#{ormtno} and ortyno=#{ortyno} and ordorg=#{ordorg}
     </select>
     
     
     <select id="querySample" resultType="com.youngor.order.SampleVO" parameterType="map">
     	 select a.plspno,a.plspnm,b.sampno,b.sampnm,
	     b.versno,a.spseno,a.spftpr,a.sprtpr,a.spbseno,a.sprseno,a.splcno,a.spbano,
	     a.spclno,a.sptyno,a.bradno,b.sexno,b.suitty,b.spltmk   
	     from ord_sample_plan a,ord_sample_design b
	     where a.plspno=b.plspno and lower(b.sampnm)=lower(#{sampnm}) and a.ormtno=#{ormtno}
	     and b.sampst=1 and a.plstat=1
     </select>
     <select id="querySampleDesignStpr" resultType="com.youngor.sample.SampleDesignStpr" parameterType="map">
     	 select a.* from ord_sample_design_stpr a
     	 where  a.sampno=#{sampno}
     </select>
     
     
     <resultMap id="querySuitVO_mapper" type="com.youngor.order.SuitVO" >  
        <id column="suitno" property="suitno"/>  
        <result column="spftpr" property="spftpr"/> 
        <result column="sprtpr" property="sprtpr"/> 
        <result column="sampno" property="sampno"/> 
        <collection property="sizeVOs" ofType="com.youngor.order.SizeVO">  
            <id column="sizeno" property="sizeno"/>  
            <result column="sizety" property="sizety"/>
            <result column="sizenm" property="sizenm"/>  
            <result column="szrate" property="szrate"/> 
            <result column="orszqt" property="orszqt"/> 
        </collection>  
          
    </resultMap>  
     <!--查询不是套西之外的小类，即表中套中拥有的规格 -->
     <select id="querySuitVO_T00" resultMap="querySuitVO_mapper" parameterType="com.youngor.order.SampleVO">
     	select a.*,nvl(b.szrate,1) szrate,c.orszqt from (
     	  SELECT '${sampno}' AS sampno,c.suitno,c.sizegp,a.sizeno,a.sizenm,a.sizety FROM ORD_PUB_SIZE a,ord_pub_sizedtl b,ord_sample_design_sizegp c  
	      where a.sizety=b.sizety and a.sizeno=b.sizeno and b.fszno=c.sizegp and  b.fszty='PRDSZTY'
	      and  c.sampno=#{sampno}
	      and a.sizety='STDSZ' and b.sizety='STDSZ'  
	    ) a left join (
	    	select * from    ORD_ORD_SZRT
            where ormtno=#{ormtno} and ordorg=#{ordorg} and bradno=#{bradno} and spclno=#{spclno} and spseno=#{spseno} and versno=#{versno}
             and sizety='STDSZ'
	    ) b
	    on a.sizegp=b.sizegp and a.sizeno=b.sizeno
	    left join (<!-- 获取已经定了的数量-->
	    	select * from ord_ordszdtl where mtorno=#{mtorno} and sampno=#{sampno} and sizety='STDSZ'
	    ) c on a.sampno=c.sampno and a.suitno=c.suitno and a.sizeno=c.sizeno
	    order by a.sizeno
     </select>
     
     <!--当小类是套西的时候，需要从套装种类中选取相应的规格范围，在pc的时候是标准的套装种类，但是在移动端还要通过ORD_SUIT_DC进行过滤-->
     <select id="querySuitVO" resultMap="querySuitVO_mapper" parameterType="com.youngor.order.SampleVO">
     	select a.*,nvl(b.szrate,1) szrate,c.orszqt from (
     	  SELECT '${sampno}' AS sampno,c.suitno,c.sizegp,a.sizeno,a.sizenm,a.sizety FROM ORD_PUB_SIZE a,ord_pub_sizedtl b,ord_sample_design_sizegp c  
	      where a.sizety=b.sizety and a.sizeno=b.sizeno and b.fszno=c.sizegp and  b.fszty='PRDSZTY'
	      and  c.sampno=#{sampno}
	      and a.sizety='STDSZ' and b.sizety='STDSZ'  
	      and exists (select 1 from ORD_SUIT_DC bb where c.suitno=bb.suitno 
	          and bb.sptyno=#{sptyno} and bb.sexno=#{sexno}  and  bb.suitty=#{suitty} and bb.spltmk=#{spltmk}
	        )
	     ) a left join (
	    	select * from    ORD_ORD_SZRT
            where ormtno=#{ormtno} and ordorg=#{ordorg} and bradno=#{bradno} and spclno=#{spclno} and spseno=#{spseno} and versno=#{versno}
             and sizety='STDSZ'
	    ) b
	    on a.sizegp=b.sizegp and a.sizeno=b.sizeno
	    left join (<!-- 获取已经定了的数量-->
	    	select * from ord_ordszdtl where mtorno=#{mtorno} and sampno=#{sampno} and sizety='STDSZ'
	    ) c on a.sampno=c.sampno and a.suitno=c.suitno and a.sizeno=c.sizeno
	    order by a.sizeno
     </select>
     <!-- 移动端进行清零按钮的时候 -->
     <delete id="clearOrddtl" parameterType="map">
     	delete ord_orddtl where mtorno=#{mtorno} and sampno=#{sampno}
     </delete>
     <delete id="clearOrdszdtl" parameterType="map">
     	delete ord_ordszdtl where mtorno=#{mtorno} and sampno=#{sampno}
     </delete>
     
     
     <!-- 查询这个订货单元可以使用的订货时间 -->
     <select id="get_ordmt_scde" resultType="com.youngor.ordmt.OrdmtScde" parameterType="map">
     	select * from ORD_ORDMT_SCDE where ormtno=#{ormtno} and channo=#{channo}
     </select>
     
     <!-- 本次订货的一些统计信息-->
     <select id="queryMyInfoVO" resultType="com.youngor.order.MyInfoVO" parameterType="map">
     	select count(mlorno) as canConfirm,sum(a.ormtqt)ormtqt_count,sum(a.ormtqs) ormtqs_count,count(distinct c.spseno) spseno_count,count(distinct c.spclno) spclno_count,count(distinct a.sampno) sampno_count 
         from ORD_ORDDTL a,ord_sample_design b,ord_sample_plan c
         where a.sampno=b.sampno and b.plspno=c.plspno
         and a.mtorno=#{mtorno}  
     </select>
     <!-- 生成版本订单号和版本号 -->
     <update id="updateMtornoMlorvn" parameterType="map">
     	  update ord_orddtl a set ORMTQS=ORMTQT,mlorvn=1,mlorno=(select mlorno from (
           select a.mtorno,a.sampno,a.suitno,a.mtorno||c.bradno||spclno as mlorno 
           from ord_orddtl a,ord_sample_design b,ord_sample_plan c
           where a.sampno=b.sampno and b.plspno=c.plspno and a.mtorno=#{mtorno}
           ) b where a.mtorno=b.mtorno and a.sampno=b.sampno and a.suitno=b.suitno
          ) 
          where a.mtorno=#{mtorno}
     </update>
     <!-- 拷贝订单明细表中的确认数量->原始数量,同时设置确认数量为0 
     <update id="updateOrmtqtZeor" parameterType="map">
     	 update ord_orddtl a set ORMTQT=0 where  a.mtorno=#{mtorno}
     </update>-->
     <!-- 创建订单副表  -->
     <insert id="createOrd_ordhd" parameterType="map">
     	   insert into ORD_ORDHD(mtorno,mlorno,MLORVN,BRADNO,SPCLNO,SDTYNO,ORSTAT,SZSTAT,ISFECT) 
       select distinct a.mtorno,a.mlorno ,a.MLORVN,c.BRADNO,c.SPCLNO,20,0,0,1
           from ord_orddtl a,ord_sample_design b,ord_sample_plan c
           where a.sampno=b.sampno and b.plspno=c.plspno and a.mtorno=#{mtorno}
     </insert>
     <!-- 创建订单副表的历史表 -->
     <insert id="createOrd_ordhd_his" parameterType="map">
     	 insert into Ord_ordhd_his
 		 select * from Ord_ordhd where mtorno=#{mtorno}
     </insert>
      <!-- 创建订单明细表的历史表 -->
     <insert id="createOrd_orddtl_his" parameterType="map">
     	 insert into Ord_orddtl_his
 		select * from Ord_orddtl where mtorno=#{mtorno}
     </insert>
     <!-- 
     <select id="queryOrdorg" parameterType="map" resultType="com.youngor.org.Org">
     	select b.* from ORD_ORD a,t_org b
      	where a.ORDORG=b.orgno  
      	<if test="channo!=null and channo!=''">
			and a.channo=#{channo}
		</if>
		<if test="ormtno!=null and ormtno!=''">
			 and a.ormtno=#{ormtno}
		</if>
		<if test="ortyno!=null and ortyno!=''">
			and a.ortyno=#{ortyno}
		</if>
     </select>
     -->
     <select id="queryOrdorg" parameterType="map" resultType="com.youngor.org.Org">
     	select b.* from ORD_ORD a,V_ORD_ORG b
      	where a.ORDORG=b.orgno  
      	<if test="channo!=null and channo!=''">
			and a.channo=#{channo}
		</if>
		<if test="ormtno!=null and ormtno!=''">
			 and a.ormtno=#{ormtno}
		</if>
		<if test="ortyno!=null and ortyno!=''">
			and a.ortyno=#{ortyno}
		</if>
		<if test="qyno!=null and qyno!=''">
			and b.qyno=#{qyno}
		</if>
     </select>
     
     <sql id="queryQyVO_where">
     	<where>
			a.ormtno=#{ormtno} 
			<if test="ortyno!=null and ortyno!=''">
				and a.ortyno=#{ortyno} 
			</if>
			<if test="channo!=null and channo!=''">
				and a.channo=#{channo} 
			</if>
			<if test="ordorg!=null and ordorg!=''">
				and a.ordorg=#{ordorg} 
			</if>
			and g.yxgsno=#{yxgsno} and g.qyno=#{qyno}
			<if test="suitno!=null and suitno!=''">
				and c.suitno='#{suitno} 
			</if>		
			and b.sdtyno='20' 
			<if test="orstat!=null and orstat!=''">
				and b.orstat=#{orstat}
			</if>
			and e.bradno=#{bradno} and e.spclno=#{spclno} 
			<if test="sptyno!=null and sptyno!=''">
				and e.sptyno=#{sptyno}
			</if>
			<if test="spseno!=null and spseno!=''">
				and e.spseno=#{spseno}
			</if> 
			<if test="sampnm!=null and sampnm!=''">
				and d.sampnm like '%${sampnm}%'
			</if> 
			
     	</where>
     </sql>
     <select id="queryQyVO" parameterType="map" resultType="com.youngor.order.QyVO" >
     	SELECT c.mtorno,b.orstat,a.channo,a.ordorg,g.orgnm as ordorg_name,e.SPCLNO,e.SPTYNO,e.SPSENO,e.plspno,e.plspnm,d.sampno,d.sampnm,d.packqt,c.suitno,c.ormtqs,c.ormtqt
		FROM ORD_ORD A
		INNER JOIN V_ORD_ORG G ON A.ORDORG=G.ORGNO
		INNER JOIN ORD_ORDDTL C ON A.MTORNO=C.MTORNO 
		LEFT JOIN ORD_ORDHD B ON A.MTORNO=B.MTORNO AND B.MLORNO=C.MLORNO AND B.MLORVN=C.MLORVN
		INNER JOIN ORD_SAMPLE_DESIGN D ON C.SAMPNO=D.SAMPNO
		INNER JOIN ORD_SAMPLE_PLAN E ON D.PLSPNO=E.PLSPNO AND A.ORMTNO=E.ORMTNO
		<include refid="queryQyVO_where"></include> 
     </select>
     
     
     <update id="updateOrmtqt" parameterType="map"  >
     	update ORD_ORDDTL set ormtqt=#{ormtqt} where mtorno=#{mtorno} and sampno=#{sampno} and suitno=#{suitno}
     </update>
</mapper>

